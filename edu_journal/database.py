import sqlite3
from sqlite3 import Error
import os

class Database:
    def __init__(self, db_path=None):
        if db_path is None:
            # Указание жесткого пути к базе данных
            db_path = r'C:\dmitiy\PKOvchinnikova_21IS_4semestr_AlekseevDmitriy\edu_journal\data\edu_journal.db'
        
        # Проверяем существование директории и создаем при необходимости
        db_dir = os.path.dirname(db_path)
        if db_dir and not os.path.exists(db_dir):
            os.makedirs(db_dir)
            print(f"✓ Создана директория: {db_dir}")
        
        print(f"Используется база данных: {os.path.abspath(db_path)}")
        self.db_path = db_path
        self.connection = None
        self.init_database()

    def create_connection(self):
        """Создание подключения к базе данных"""
        try:
            self.connection = sqlite3.connect(self.db_path)
            print(f"✓ Подключение к базе данных установлено")
            print(f"✓ База данных находится в: {os.path.abspath(self.db_path)}")
            return self.connection
        except Error as e:
            print(f"✗ Ошибка подключения к базе данных: {e}")
            print(f"Путь: {self.db_path}")
            return None

    def init_database(self):
        """Инициализация базы данных с тестовыми данными по ФГОС"""
        conn = self.create_connection()
        if conn is not None:
            try:
                cursor = conn.cursor()
                
                # Создание таблицы пользователей
                cursor.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    username TEXT UNIQUE NOT NULL,
                    password TEXT NOT NULL,
                    role TEXT NOT NULL CHECK(role IN ('teacher', 'student')),
                    full_name TEXT NOT NULL,
                    specialty TEXT,
                    group_name TEXT,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
                ''')

                # Создание таблицы предметов
                cursor.execute('''
                CREATE TABLE IF NOT EXISTS subjects (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    code TEXT,
                    specialty TEXT,
                    teacher_id INTEGER REFERENCES users(id)
                )
                ''')

                # Создание таблицы компетенций ФГОС
                cursor.execute('''
                CREATE TABLE IF NOT EXISTS fgos_competencies (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    code TEXT UNIQUE NOT NULL,
                    name TEXT NOT NULL,
                    description TEXT,
                    specialty TEXT,
                    type TEXT CHECK(type IN ('ПК', 'ОПК', 'УК'))
                )
                ''')

                # Создание таблицы индикаторов освоения (пунктов ФГОС)
                cursor.execute('''
                CREATE TABLE IF NOT EXISTS fgos_indicators (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    competency_id INTEGER NOT NULL,
                    code TEXT NOT NULL,
                    description TEXT NOT NULL,
                    weight INTEGER DEFAULT 1,
                    max_score INTEGER DEFAULT 1,
                    FOREIGN KEY (competency_id) REFERENCES fgos_competencies(id)
                )
                ''')

                # Создание таблицы оценок с привязкой к индикаторам ФГОС
                cursor.execute('''
                CREATE TABLE IF NOT EXISTS grades (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    student_id INTEGER NOT NULL,
                    teacher_id INTEGER NOT NULL,
                    subject_id INTEGER NOT NULL,
                    competency_id INTEGER NOT NULL,
                    
                    -- Данные по ФГОС
                    grade_value INTEGER NOT NULL CHECK(grade_value BETWEEN 2 AND 5),
                    percentage INTEGER NOT NULL CHECK(percentage BETWEEN 0 AND 100),
                    comment TEXT NOT NULL CHECK(LENGTH(comment) >= 100),
                    
                    -- Системные поля
                    date DATE NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    
                    FOREIGN KEY (student_id) REFERENCES users(id),
                    FOREIGN KEY (teacher_id) REFERENCES users(id),
                    FOREIGN KEY (subject_id) REFERENCES subjects(id),
                    FOREIGN KEY (competency_id) REFERENCES fgos_competencies(id)
                )
                ''')

                # Таблица для хранения выбранных индикаторов для каждой оценки
                cursor.execute('''
                CREATE TABLE IF NOT EXISTS grade_indicators (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    grade_id INTEGER NOT NULL,
                    indicator_id INTEGER NOT NULL,
                    score INTEGER NOT NULL DEFAULT 1,
                    FOREIGN KEY (grade_id) REFERENCES grades(id),
                    FOREIGN KEY (indicator_id) REFERENCES fgos_indicators(id)
                )
                ''')

                # Добавление тестовых пользователей
                cursor.execute("SELECT COUNT(*) FROM users")
                if cursor.fetchone()[0] == 0:
                    print("Добавление тестовых пользователей...")
                    test_users = [
                        ('teacher1', '123456', 'teacher', 'Иванов Иван Иванович', '15.02.01', 'Преподаватель'),
                        ('student1', '123456', 'student', 'Петров Петр Петрович', '15.02.01', 'Группа 101'),
                        ('student2', '123456', 'student', 'Сидорова Анна Сергеевна', '15.02.01', 'Группа 101'),
                        ('student3', '123456', 'student', 'Козлова Елена Владимировна', '15.02.01', 'Группа 102'),
                        ('student4', '123456', 'student', 'Николаев Андрей Сергеевич', '15.02.01', 'Группа 102'),
                    ]
                    cursor.executemany(
                        "INSERT INTO users (username, password, role, full_name, specialty, group_name) VALUES (?, ?, ?, ?, ?, ?)",
                        test_users
                    )

                # Добавление тестовых предметов
                cursor.execute("SELECT COUNT(*) FROM subjects")
                if cursor.fetchone()[0] == 0:
                    print("Добавление тестовых предметов...")
                    test_subjects = [
                        ('Математика', 'МАТ-101', '15.02.01', 1),
                        ('Программирование', 'ПРОГ-102', '15.02.01', 1),
                        ('Базы данных', 'БД-103', '15.02.01', 1),
                        ('Электротехника', 'ЭЛ-104', '15.02.01', 1),
                        ('Автоматизация процессов', 'АП-105', '15.02.01', 1),
                        ('Техническая механика', 'ТМ-106', '15.02.01', 1),
                        ('Информационные технологии', 'ИТ-107', '15.02.01', 1),
                    ]
                    cursor.executemany(
                        "INSERT INTO subjects (name, code, specialty, teacher_id) VALUES (?, ?, ?, ?)",
                        test_subjects
                    )

                # Добавление компетенций ФГОС для специальности 15.02.01 (Автоматизация технологических процессов)
                cursor.execute("SELECT COUNT(*) FROM fgos_competencies")
                if cursor.fetchone()[0] == 0:
                    print("Добавление компетенций ФГОС...")
                    competencies = [
                        # Профессиональные компетенции (ПК)
                        ('ПК 1.1', 'Выполнять наладку, регулировку и проверку электрического и электромеханического оборудования', 
                         'Наладка и регулировка оборудования', '15.02.01', 'ПК'),
                        ('ПК 1.2', 'Осуществлять диагностирование и техническое обслуживание электрооборудования', 
                         'Диагностика и обслуживание', '15.02.01', 'ПК'),
                        ('ПК 1.3', 'Производить монтаж и демонтаж электрооборудования', 
                         'Монтаж и демонтаж', '15.02.01', 'ПК'),
                        ('ПК 1.4', 'Выполнять ремонт электрических машин и аппаратов', 
                         'Ремонт оборудования', '15.02.01', 'ПК'),
                        ('ПК 2.1', 'Разрабатывать и оформлять конструкторскую и технологическую документацию', 
                         'Разработка документации', '15.02.01', 'ПК'),
                        ('ПК 2.2', 'Выполнять расчеты и конструирование деталей и узлов электрооборудования', 
                         'Расчеты и конструирование', '15.02.01', 'ПК'),
                        ('ПК 2.3', 'Проектировать системы автоматизации', 
                         'Проектирование систем', '15.02.01', 'ПК'),
                        ('ПК 3.1', 'Контролировать и анализировать функционирование параметров оборудования', 
                         'Контроль параметров', '15.02.01', 'ПК'),
                        ('ПК 3.2', 'Настраивать и программировать контроллеры', 
                         'Настройка контроллеров', '15.02.01', 'ПК'),
                        ('ПК 3.3', 'Эксплуатировать системы автоматического управления', 
                         'Эксплуатация систем', '15.02.01', 'ПК'),
                        ('ПК 4.1', 'Обеспечивать безопасность труда при эксплуатации электрооборудования', 
                         'Безопасность труда', '15.02.01', 'ПК'),
                        
                        # Общепрофессиональные компетенции (ОПК)
                        ('ОПК 1.1', 'Понимать сущность и социальную значимость своей будущей профессии', 
                         'Понимание профессии', '15.02.01', 'ОПК'),
                        ('ОПК 1.2', 'Проявлять к ней устойчивый интерес', 
                         'Интерес к профессии', '15.02.01', 'ОПК'),
                        ('ОПК 2.1', 'Организовывать собственную деятельность', 
                         'Организация деятельности', '15.02.01', 'ОПК'),
                        ('ОПК 2.2', 'Выбирать типовые методы и способы выполнения задач', 
                         'Выбор методов', '15.02.01', 'ОПК'),
                        ('ОПК 3.1', 'Работать в коллективе и команде', 
                         'Работа в команде', '15.02.01', 'ОПК'),
                        ('ОПК 3.2', 'Эффективно общаться с коллегами', 
                         'Эффективное общение', '15.02.01', 'ОПК'),
                        ('ОПК 4.1', 'Осуществлять поиск и использование информации', 
                         'Работа с информацией', '15.02.01', 'ОПК'),
                        ('ОПК 4.2', 'Оценивать информацию критически', 
                         'Критическое мышление', '15.02.01', 'ОПК'),
                        ('ОПК 5.1', 'Использовать информационно-коммуникационные технологии', 
                         'ИКТ компетенции', '15.02.01', 'ОПК'),
                        
                        # Универсальные компетенции (УК)
                        ('УК 1.1', 'Понимать и анализировать мировоззренческие проблемы', 
                         'Мировоззрение', '15.02.01', 'УК'),
                        ('УК 1.2', 'Ориентироваться в системе духовных ценностей', 
                         'Ценностные ориентиры', '15.02.01', 'УК'),
                        ('УК 2.1', 'Использовать современные коммуникативные технологии', 
                         'Коммуникативные технологии', '15.02.01', 'УК'),
                        ('УК 2.2', 'Работать с различными источниками информации', 
                         'Работа с источниками', '15.02.01', 'УК'),
                        ('УК 3.1', 'Самостоятельно определять задачи профессионального развития', 
                         'Профессиональное развитие', '15.02.01', 'УК'),
                        ('УК 3.2', 'Осуществлять планирование своего развития', 
                         'Планирование развития', '15.02.01', 'УК'),
                        ('УК 4.1', 'Применять знания в нестандартных ситуациях', 
                         'Креативное мышление', '15.02.01', 'УК'),
                        ('УК 4.2', 'Находить нестандартные решения проблем', 
                         'Решение проблем', '15.02.01', 'УК'),
                    ]
                    cursor.executemany(
                        "INSERT INTO fgos_competencies (code, name, description, specialty, type) VALUES (?, ?, ?, ?, ?)",
                        competencies
                    )

                # Добавление индикаторов освоения для каждой компетенции
                cursor.execute("SELECT COUNT(*) FROM fgos_indicators")
                if cursor.fetchone()[0] == 0:
                    print("Добавление индикаторов ФГОС...")
                    
                    # Получаем ID компетенций
                    cursor.execute("SELECT id, code FROM fgos_competencies")
                    competencies_dict = {row[1]: row[0] for row in cursor.fetchall()}
                    
                    indicators = [
                        # Индикаторы для ПК 1.1 (8 пунктов)
                        (competencies_dict['ПК 1.1'], 'ПК 1.1.1', 'Выполнил наладку оборудования согласно инструкции', 1, 1),
                        (competencies_dict['ПК 1.1'], 'ПК 1.1.2', 'Произвел регулировку параметров в заданных пределах', 1, 1),
                        (competencies_dict['ПК 1.1'], 'ПК 1.1.3', 'Проверил работоспособность после наладки', 1, 1),
                        (competencies_dict['ПК 1.1'], 'ПК 1.1.4', 'Выявил и устранил неисправности', 2, 1),
                        (competencies_dict['ПК 1.1'], 'ПК 1.1.5', 'Документировал результаты наладки', 1, 1),
                        (competencies_dict['ПК 1.1'], 'ПК 1.1.6', 'Соблюл технику безопасности при работе с оборудованием', 2, 1),
                        (competencies_dict['ПК 1.1'], 'ПК 1.1.7', 'Применил инструменты и приборы контроля', 1, 1),
                        (competencies_dict['ПК 1.1'], 'ПК 1.1.8', 'Проанализировал причины неисправностей', 2, 1),
                        
                        # Индикаторы для ПК 1.2 (8 пунктов)
                        (competencies_dict['ПК 1.2'], 'ПК 1.2.1', 'Провел диагностику оборудования', 1, 1),
                        (competencies_dict['ПК 1.2'], 'ПК 1.2.2', 'Выполнил техническое обслуживание по плану', 1, 1),
                        (competencies_dict['ПК 1.2'], 'ПК 1.2.3', 'Определил изношенные детали', 1, 1),
                        (competencies_dict['ПК 1.2'], 'ПК 1.2.4', 'Составил отчет о техническом состоянии', 2, 1),
                        (competencies_dict['ПК 1.2'], 'ПК 1.2.5', 'Произвел замену изношенных деталей', 2, 1),
                        (competencies_dict['ПК 1.2'], 'ПК 1.2.6', 'Выполнил профилактические работы', 1, 1),
                        (competencies_dict['ПК 1.2'], 'ПК 1.2.7', 'Применил диагностическое оборудование', 1, 1),
                        (competencies_dict['ПК 1.2'], 'ПК 1.2.8', 'Оценил ресурс оборудования после обслуживания', 2, 1),
                        
                        # Индикаторы для ПК 1.3 (6 пунктов)
                        (competencies_dict['ПК 1.3'], 'ПК 1.3.1', 'Выполнил монтаж электрооборудования', 1, 1),
                        (competencies_dict['ПК 1.3'], 'ПК 1.3.2', 'Произвел демонтаж оборудования', 1, 1),
                        (competencies_dict['ПК 1.3'], 'ПК 1.3.3', 'Соблюл технологическую последовательность', 2, 1),
                        (competencies_dict['ПК 1.3'], 'ПК 1.3.4', 'Использовал специальный инструмент', 1, 1),
                        (competencies_dict['ПК 1.3'], 'ПК 1.3.5', 'Проверил качество монтажа', 2, 1),
                        (competencies_dict['ПК 1.3'], 'ПК 1.3.6', 'Составил акт выполненных работ', 1, 1),
                        
                        # Индикаторы для ПК 1.4 (6 пунктов)
                        (competencies_dict['ПК 1.4'], 'ПК 1.4.1', 'Диагностировал неисправность', 1, 1),
                        (competencies_dict['ПК 1.4'], 'ПК 1.4.2', 'Разобрал оборудование для ремонта', 1, 1),
                        (competencies_dict['ПК 1.4'], 'ПК 1.4.3', 'Заменил неисправные компоненты', 2, 1),
                        (competencies_dict['ПК 1.4'], 'ПК 1.4.4', 'Собрал оборудование после ремонта', 1, 1),
                        (competencies_dict['ПК 1.4'], 'ПК 1.4.5', 'Протестировал работоспособность', 2, 1),
                        (competencies_dict['ПК 1.4'], 'ПК 1.4.6', 'Оформил ремонтную документацию', 1, 1),
                        
                        # Индикаторы для ПК 2.1 (8 пунктов)
                        (competencies_dict['ПК 2.1'], 'ПК 2.1.1', 'Разработал чертеж детали', 1, 1),
                        (competencies_dict['ПК 2.1'], 'ПК 2.1.2', 'Оформил технологическую карту', 1, 1),
                        (competencies_dict['ПК 2.1'], 'ПК 2.1.3', 'Соблюл требования ЕСКД', 2, 1),
                        (competencies_dict['ПК 2.1'], 'ПК 2.1.4', 'Применил стандарты оформления', 1, 1),
                        (competencies_dict['ПК 2.1'], 'ПК 2.1.5', 'Рассчитал технологические параметры', 2, 1),
                        (competencies_dict['ПК 2.1'], 'ПК 2.1.6', 'Выполнил спецификацию материалов', 1, 1),
                        (competencies_dict['ПК 2.1'], 'ПК 2.1.7', 'Разработал сборочный чертеж', 2, 1),
                        (competencies_dict['ПК 2.1'], 'ПК 2.1.8', 'Применил средства автоматизированного проектирования', 2, 1),
                        
                        # Индикаторы для ПК 2.2 (8 пунктов)
                        (competencies_dict['ПК 2.2'], 'ПК 2.2.1', 'Выполнил расчеты прочности деталей', 2, 1),
                        (competencies_dict['ПК 2.2'], 'ПК 2.2.2', 'Спроектировал узел электрооборудования', 2, 1),
                        (competencies_dict['ПК 2.2'], 'ПК 2.2.3', 'Подобрал материалы для конструкции', 1, 1),
                        (competencies_dict['ПК 2.2'], 'ПК 2.2.4', 'Рассчитал электрические параметры', 2, 1),
                        (competencies_dict['ПК 2.2'], 'ПК 2.2.5', 'Разработал компоновку оборудования', 1, 1),
                        (competencies_dict['ПК 2.2'], 'ПК 2.2.6', 'Выполнил проверку расчетов', 1, 1),
                        (competencies_dict['ПК 2.2'], 'ПК 2.2.7', 'Оптимизировал конструкцию по массе', 2, 1),
                        (competencies_dict['ПК 2.2'], 'ПК 2.2.8', 'Учел требования эргономики', 1, 1),
                        
                        # Индикаторы для ПК 2.3 (6 пунктов)
                        (competencies_dict['ПК 2.3'], 'ПК 2.3.1', 'Проанализировал требования к системе', 1, 1),
                        (competencies_dict['ПК 2.3'], 'ПК 2.3.2', 'Разработал структурную схему', 2, 1),
                        (competencies_dict['ПК 2.3'], 'ПК 2.3.3', 'Выбрал компоненты системы', 1, 1),
                        (competencies_dict['ПК 2.3'], 'ПК 2.3.4', 'Спроектировал алгоритм управления', 2, 1),
                        (competencies_dict['ПК 2.3'], 'ПК 2.3.5', 'Рассчитал параметры системы', 2, 1),
                        (competencies_dict['ПК 2.3'], 'ПК 2.3.6', 'Оформил проектную документацию', 1, 1),
                        
                        # Индикаторы для ПК 3.1 (8 пунктов)
                        (competencies_dict['ПК 3.1'], 'ПК 3.1.1', 'Контролировал параметры оборудования', 1, 1),
                        (competencies_dict['ПК 3.1'], 'ПК 3.1.2', 'Анализировал функционирование систем', 2, 1),
                        (competencies_dict['ПК 3.1'], 'ПК 3.1.3', 'Выявил отклонения от нормативных значений', 2, 1),
                        (competencies_dict['ПК 3.1'], 'ПК 3.1.4', 'Составил отчет по контролю', 1, 1),
                        (competencies_dict['ПК 3.1'], 'ПК 3.1.5', 'Применил средства автоматического контроля', 2, 1),
                        (competencies_dict['ПК 3.1'], 'ПК 3.1.6', 'Проанализировал тренды параметров', 2, 1),
                        (competencies_dict['ПК 3.1'], 'ПК 3.1.7', 'Разработал рекомендации по оптимизации', 2, 1),
                        (competencies_dict['ПК 3.1'], 'ПК 3.1.8', 'Оценил эффективность работы оборудования', 2, 1),
                        
                        # Индикаторы для ПК 3.2 (6 пунктов)
                        (competencies_dict['ПК 3.2'], 'ПК 3.2.1', 'Изучил инструкцию контроллера', 1, 1),
                        (competencies_dict['ПК 3.2'], 'ПК 3.2.2', 'Настроил параметры контроллера', 2, 1),
                        (competencies_dict['ПК 3.2'], 'ПК 3.2.3', 'Написал программу управления', 2, 1),
                        (competencies_dict['ПК 3.2'], 'ПК 3.2.4', 'Протестировал программу', 2, 1),
                        (competencies_dict['ПК 3.2'], 'ПК 3.2.5', 'Отладил систему управления', 2, 1),
                        (competencies_dict['ПК 3.2'], 'ПК 3.2.6', 'Документировал настройки', 1, 1),
                        
                        # Индикаторы для ПК 3.3 (6 пунктов)
                        (competencies_dict['ПК 3.3'], 'ПК 3.3.1', 'Изучил руководство по эксплуатации', 1, 1),
                        (competencies_dict['ПК 3.3'], 'ПК 3.3.2', 'Запустил систему автоматизации', 1, 1),
                        (competencies_dict['ПК 3.3'], 'ПК 3.3.3', 'Контролировал работу системы', 2, 1),
                        (competencies_dict['ПК 3.3'], 'ПК 3.3.4', 'Реагировал на аварийные ситуации', 2, 1),
                        (competencies_dict['ПК 3.3'], 'ПК 3.3.5', 'Вел журнал эксплуатации', 1, 1),
                        (competencies_dict['ПК 3.3'], 'ПК 3.3.6', 'Провел плановое обслуживание', 2, 1),
                        
                        # Индикаторы для ПК 4.1 (6 пунктов)
                        (competencies_dict['ПК 4.1'], 'ПК 4.1.1', 'Изучил правила безопасности', 1, 1),
                        (competencies_dict['ПК 4.1'], 'ПК 4.1.2', 'Применил средства индивидуальной защиты', 1, 1),
                        (competencies_dict['ПК 4.1'], 'ПК 4.1.3', 'Обеспечил безопасные условия работы', 2, 1),
                        (competencies_dict['ПК 4.1'], 'ПК 4.1.4', 'Провел инструктаж по безопасности', 2, 1),
                        (competencies_dict['ПК 4.1'], 'ПК 4.1.5', 'Контролировал соблюдение правил', 2, 1),
                        (competencies_dict['ПК 4.1'], 'ПК 4.1.6', 'Оформил документацию по безопасности', 1, 1),
                        
                        # Индикаторы для ОПК 1.1 (6 пунктов)
                        (competencies_dict['ОПК 1.1'], 'ОПК 1.1.1', 'Объяснил социальную значимость профессии', 1, 1),
                        (competencies_dict['ОПК 1.1'], 'ОПК 1.1.2', 'Описал профессиональные обязанности', 1, 1),
                        (competencies_dict['ОПК 1.1'], 'ОПК 1.1.3', 'Определил перспективы развития профессии', 2, 1),
                        (competencies_dict['ОПК 1.1'], 'ОПК 1.1.4', 'Проанализировал требования к специалисту', 1, 1),
                        (competencies_dict['ОПК 1.1'], 'ОПК 1.1.5', 'Оценил свою готовность к профессии', 2, 1),
                        (competencies_dict['ОПК 1.1'], 'ОПК 1.1.6', 'Представил профессию в современном контексте', 2, 1),
                        
                        # Индикаторы для ОПК 1.2 (6 пунктов)
                        (competencies_dict['ОПК 1.2'], 'ОПК 1.2.1', 'Проявил интерес к профессии', 1, 1),
                        (competencies_dict['ОПК 1.2'], 'ОПК 1.2.2', 'Изучал дополнительную литературу', 1, 1),
                        (competencies_dict['ОПК 1.2'], 'ОПК 1.2.3', 'Посещал профильные мероприятия', 2, 1),
                        (competencies_dict['ОПК 1.2'], 'ОПК 1.2.4', 'Общался с профессионалами', 2, 1),
                        (competencies_dict['ОПК 1.2'], 'ОПК 1.2.5', 'Следил за новостями отрасли', 1, 1),
                        (competencies_dict['ОПК 1.2'], 'ОПК 1.2.6', 'Участвовал в профессиональных обсуждениях', 2, 1),
                        
                        # Индикаторы для ОПК 2.1 (6 пунктов)
                        (competencies_dict['ОПК 2.1'], 'ОПК 2.1.1', 'Составил план работы', 1, 1),
                        (competencies_dict['ОПК 2.1'], 'ОПК 2.1.2', 'Распределил время эффективно', 1, 1),
                        (competencies_dict['ОПК 2.1'], 'ОПК 2.1.3', 'Выполнил работу в срок', 2, 1),
                        (competencies_dict['ОПК 2.1'], 'ОПК 2.1.4', 'Проанализировал результаты', 1, 1),
                        (competencies_dict['ОПК 2.1'], 'ОПК 2.1.5', 'Скорректировал план при необходимости', 2, 1),
                        (competencies_dict['ОПК 2.1'], 'ОПК 2.1.6', 'Оценил эффективность организации', 2, 1),
                        
                        # Индикаторы для ОПК 2.2 (6 пунктов)
                        (competencies_dict['ОПК 2.2'], 'ОПК 2.2.1', 'Выбрал метод решения задачи', 1, 1),
                        (competencies_dict['ОПК 2.2'], 'ОПК 2.2.2', 'Сравнил альтернативные методы', 2, 1),
                        (competencies_dict['ОПК 2.2'], 'ОПК 2.2.3', 'Обосновал выбор метода', 2, 1),
                        (competencies_dict['ОПК 2.2'], 'ОПК 2.2.4', 'Применил метод на практике', 2, 1),
                        (competencies_dict['ОПК 2.2'], 'ОПК 2.2.5', 'Оценил эффективность метода', 2, 1),
                        (competencies_dict['ОПК 2.2'], 'ОПК 2.2.6', 'Адаптировал метод к условиям задачи', 2, 1),
                        
                        # Индикаторы для ОПК 3.1 (6 пунктов)
                        (competencies_dict['ОПК 3.1'], 'ОПК 3.1.1', 'Участвовал в обсуждении задачи', 1, 1),
                        (competencies_dict['ОПК 3.1'], 'ОПК 3.1.2', 'Выполнил свою часть работы', 1, 1),
                        (competencies_dict['ОПК 3.1'], 'ОПК 3.1.3', 'Помог другим членам команды', 2, 1),
                        (competencies_dict['ОПК 3.1'], 'ОПК 3.1.4', 'Представил результаты команды', 1, 1),
                        (competencies_dict['ОПК 3.1'], 'ОПК 3.1.5', 'Разрешил конфликтные ситуации', 2, 1),
                        (competencies_dict['ОПК 3.1'], 'ОПК 3.1.6', 'Проявил лидерские качества', 2, 1),
                        
                        # Индикаторы для ОПК 3.2 (6 пунктов)
                        (competencies_dict['ОПК 3.2'], 'ОПК 3.2.1', 'Ясно выражал мысли', 1, 1),
                        (competencies_dict['ОПК 3.2'], 'ОПК 3.2.2', 'Слушал и понимал других', 1, 1),
                        (competencies_dict['ОПК 3.2'], 'ОПК 3.2.3', 'Задавал уточняющие вопросы', 1, 1),
                        (competencies_dict['ОПК 3.2'], 'ОПК 3.2.4', 'Давал конструктивную обратную связь', 2, 1),
                        (competencies_dict['ОПК 3.2'], 'ОПК 3.2.5', 'Использовал профессиональную терминологию', 2, 1),
                        (competencies_dict['ОПК 3.2'], 'ОПК 3.2.6', 'Адаптировал стиль общения к ситуации', 2, 1),
                        
                        # Индикаторы для ОПК 4.1 (6 пунктов)
                        (competencies_dict['ОПК 4.1'], 'ОПК 4.1.1', 'Нашел необходимую информацию', 1, 1),
                        (competencies_dict['ОПК 4.1'], 'ОПК 4.1.2', 'Проанализировал источники информации', 1, 1),
                        (competencies_dict['ОПК 4.1'], 'ОПК 4.1.3', 'Применил информацию для решения задачи', 2, 1),
                        (competencies_dict['ОПК 4.1'], 'ОПК 4.1.4', 'Оценил достоверность информации', 2, 1),
                        (competencies_dict['ОПК 4.1'], 'ОПК 4.1.5', 'Систематизировал полученные данные', 1, 1),
                        (competencies_dict['ОПК 4.1'], 'ОПК 4.1.6', 'Представил информацию в структурированном виде', 1, 1),
                        
                        # Индикаторы для ОПК 4.2 (6 пунктов)
                        (competencies_dict['ОПК 4.2'], 'ОПК 4.2.1', 'Выявил противоречия в информации', 2, 1),
                        (competencies_dict['ОПК 4.2'], 'ОПК 4.2.2', 'Проверил факты', 1, 1),
                        (competencies_dict['ОПК 4.2'], 'ОПК 4.2.3', 'Сравнил разные точки зрения', 2, 1),
                        (competencies_dict['ОПК 4.2'], 'ОПК 4.2.4', 'Выявил предвзятость источников', 2, 1),
                        (competencies_dict['ОПК 4.2'], 'ОПК 4.2.5', 'Сформировал собственную оценку', 2, 1),
                        (competencies_dict['ОПК 4.2'], 'ОПК 4.2.6', 'Обосновал свою позицию', 2, 1),
                        
                        # Индикаторы для ОПК 5.1 (6 пунктов)
                        (competencies_dict['ОПК 5.1'], 'ОПК 5.1.1', 'Использовал компьютер для работы', 1, 1),
                        (competencies_dict['ОПК 5.1'], 'ОПК 5.1.2', 'Применил специализированное ПО', 2, 1),
                        (competencies_dict['ОПК 5.1'], 'ОПК 5.1.3', 'Работал с офисными программами', 1, 1),
                        (competencies_dict['ОПК 5.1'], 'ОПК 5.1.4', 'Использовал интернет-ресурсы', 1, 1),
                        (competencies_dict['ОПК 5.1'], 'ОПК 5.1.5', 'Создал презентацию', 2, 1),
                        (competencies_dict['ОПК 5.1'], 'ОПК 5.1.6', 'Организовал данные в цифровом виде', 1, 1),
                        
                        # Индикаторы для УК 1.1 (6 пунктов)
                        (competencies_dict['УК 1.1'], 'УК 1.1.1', 'Проанализировал мировоззренческие проблемы', 2, 1),
                        (competencies_dict['УК 1.1'], 'УК 1.1.2', 'Сформулировал собственную позицию', 2, 1),
                        (competencies_dict['УК 1.1'], 'УК 1.1.3', 'Рассмотрел проблему с разных точек зрения', 1, 1),
                        (competencies_dict['УК 1.1'], 'УК 1.1.4', 'Применил философские знания', 1, 1),
                        (competencies_dict['УК 1.1'], 'УК 1.1.5', 'Обосновал свою позицию', 2, 1),
                        (competencies_dict['УК 1.1'], 'УК 1.1.6', 'Уважил мнение других', 1, 1),
                        
                        # Индикаторы для УК 1.2 (6 пунктов)
                        (competencies_dict['УК 1.2'], 'УК 1.2.1', 'Определил свои ценности', 1, 1),
                        (competencies_dict['УК 1.2'], 'УК 1.2.2', 'Соотнес ценности с профессиональной этикой', 2, 1),
                        (competencies_dict['УК 1.2'], 'УК 1.2.3', 'Проявил толерантность', 1, 1),
                        (competencies_dict['УК 1.2'], 'УК 1.2.4', 'Соблюл моральные нормы', 2, 1),
                        (competencies_dict['УК 1.2'], 'УК 1.2.5', 'Принял ответственное решение', 2, 1),
                        (competencies_dict['УК 1.2'], 'УК 1.2.6', 'Объяснил свою позицию с точки зрения ценностей', 2, 1),
                        
                        # Индикаторы для УК 2.1 (6 пунктов)
                        (competencies_dict['УК 2.1'], 'УК 2.1.1', 'Использовал коммуникативные технологии', 1, 1),
                        (competencies_dict['УК 2.1'], 'УК 2.1.2', 'Создал презентацию', 1, 1),
                        (competencies_dict['УК 2.1'], 'УК 2.1.3', 'Провел онлайн-конференцию', 2, 1),
                        (competencies_dict['УК 2.1'], 'УК 2.1.4', 'Использовал облачные технологии', 2, 1),
                        (competencies_dict['УК 2.1'], 'УК 2.1.5', 'Применил средства совместной работы', 1, 1),
                        (competencies_dict['УК 2.1'], 'УК 2.1.6', 'Оценил эффективность технологий', 2, 1),
                        
                        # Индикаторы для УК 2.2 (6 пунктов)
                        (competencies_dict['УК 2.2'], 'УК 2.2.1', 'Нашел информацию в библиотеке', 1, 1),
                        (competencies_dict['УК 2.2'], 'УК 2.2.2', 'Использовал базы данных', 2, 1),
                        (competencies_dict['УК 2.2'], 'УК 2.2.3', 'Работал с научной литература', 2, 1),
                        (competencies_dict['УК 2.2'], 'УК 2.2.4', 'Применил справочные материалы', 1, 1),
                        (competencies_dict['УК 2.2'], 'УК 2.2.5', 'Сравнил разные источники', 2, 1),
                        (competencies_dict['УК 2.2'], 'УК 2.2.6', 'Систематизировал найденную информацию', 1, 1),
                        
                        # Индикаторы для УК 3.1 (6 пунктов)
                        (competencies_dict['УК 3.1'], 'УК 3.1.1', 'Определил цели развития', 1, 1),
                        (competencies_dict['УК 3.1'], 'УК 3.1.2', 'Составил план самообразования', 1, 1),
                        (competencies_dict['УК 3.1'], 'УК 3.1.3', 'Изучил дополнительную литературу', 2, 1),
                        (competencies_dict['УК 3.1'], 'УК 3.1.4', 'Применил новые знания на практике', 2, 1),
                        (competencies_dict['УК 3.1'], 'УК 3.1.5', 'Проанализировал результаты развития', 2, 1),
                        (competencies_dict['УК 3.1'], 'УК 3.1.6', 'Скорректировал план развития', 2, 1),
                        
                        # Индикаторы для УК 3.2 (6 пунктов)
                        (competencies_dict['УК 3.2'], 'УК 3.2.1', 'Разработал долгосрочный план', 2, 1),
                        (competencies_dict['УК 3.2'], 'УК 3.2.2', 'Определил этапы развития', 1, 1),
                        (competencies_dict['УК 3.2'], 'УК 3.2.3', 'Установил критерии успеха', 2, 1),
                        (competencies_dict['УК 3.2'], 'УК 3.2.4', 'Распределил ресурсы', 2, 1),
                        (competencies_dict['УК 3.2'], 'УК 3.2.5', 'Контролировал выполнение плана', 2, 1),
                        (competencies_dict['УК 3.2'], 'УК 3.2.6', 'Оценил достигнутые результаты', 2, 1),
                        
                        # Индикаторы для УК 4.1 (6 пунктов)
                        (competencies_dict['УК 4.1'], 'УК 4.1.1', 'Распознал нестандартную ситуацию', 2, 1),
                        (competencies_dict['УК 4.1'], 'УК 4.1.2', 'Адаптировал знания к новой ситуации', 2, 1),
                        (competencies_dict['УК 4.1'], 'УК 4.1.3', 'Проявил гибкость мышления', 2, 1),
                        (competencies_dict['УК 4.1'], 'УК 4.1.4', 'Использовал знания из разных областей', 2, 1),
                        (competencies_dict['УК 4.1'], 'УК 4.1.5', 'Нашел аналогии', 1, 1),
                        (competencies_dict['УК 4.1'], 'УК 4.1.6', 'Дал нестандартное решение', 2, 1),
                        
                        # Индикаторы для УК 4.2 (6 пунктов)
                        (competencies_dict['УК 4.2'], 'УК 4.2.1', 'Выявил суть проблемы', 2, 1),
                        (competencies_dict['УК 4.2'], 'УК 4.2.2', 'Рассмотрел альтернативные решения', 2, 1),
                        (competencies_dict['УК 4.2'], 'УК 4.2.3', 'Оценил риски и преимущества', 2, 1),
                        (competencies_dict['УК 4.2'], 'УК 4.2.4', 'Выбрал оптимальное решение', 2, 1),
                        (competencies_dict['УК 4.2'], 'УК 4.2.5', 'Разработал план реализации', 2, 1),
                        (competencies_dict['УК 4.2'], 'УК 4.2.6', 'Оценил результаты решения', 2, 1),
                    ]
                    
                    cursor.executemany(
                        "INSERT INTO fgos_indicators (competency_id, code, description, weight, max_score) VALUES (?, ?, ?, ?, ?)",
                        indicators
                    )
                    print(f"✓ Добавлено {len(indicators)} индикаторов освоения")

                # Добавление тестовых оценок
                cursor.execute("SELECT COUNT(*) FROM grades")
                if cursor.fetchone()[0] == 0:
                    print("Добавление тестовых оценок...")
                    
                    # Получаем ID для тестовых данных
                    cursor.execute("SELECT id FROM users WHERE username = 'student1'")
                    student1_id = cursor.fetchone()[0]
                    
                    cursor.execute("SELECT id FROM users WHERE username = 'student2'")
                    student2_id = cursor.fetchone()[0]
                    
                    cursor.execute("SELECT id FROM subjects WHERE name = 'Математика'")
                    math_subject_id = cursor.fetchone()[0]
                    
                    cursor.execute("SELECT id FROM subjects WHERE name = 'Программирование'")
                    prog_subject_id = cursor.fetchone()[0]
                    
                    cursor.execute("SELECT id FROM fgos_competencies WHERE code = 'ПК 2.2'")
                    pk_2_2_id = cursor.fetchone()[0]
                    
                    cursor.execute("SELECT id FROM fgos_competencies WHERE code = 'ОПК 3.1'")
                    opk_3_1_id = cursor.fetchone()[0]
                    
                    cursor.execute("SELECT id FROM fgos_competencies WHERE code = 'УК 3.1'")
                    uk_3_1_id = cursor.fetchone()[0]
                    
                    # Добавляем несколько оценок
                    test_grades = [
                        # Оценка по математике для студента 1
                        (student1_id, 1, math_subject_id, pk_2_2_id, 5, 88, 
                         'Студент отлично освоил компетенцию ПК 2.2 "Выполнять расчеты и конструирование деталей". Выполнил все расчеты прочности, спроектировал узел электрооборудования, правильно подобрал материалы. Показал умение работать с чертежами и спецификациями. Проявил творческий подход при оптимизации конструкции.',
                         '2024-02-15'),
                         
                        # Оценка по программированию для студента 1
                        (student1_id, 1, prog_subject_id, opk_3_1_id, 4, 75,
                         'Студент хорошо освоил компетенцию ОПК 3.1 "Работать в коллективе и команде". Активно участвовал в командных проектах, помогал коллегам, проявлял лидерские качества при организации работы группы. Нуждается в развитии навыков разрешения конфликтных ситуаций.',
                         '2024-02-20'),
                         
                        # Оценка по программированию для студента 2
                        (student2_id, 1, prog_subject_id, uk_3_1_id, 3, 58,
                         'Студент освоил базовый уровень компетенции УК 3.1 "Самостоятельно определять задачи профессионального развития". Определил цели развития, составил план самообразования, но недостаточно применяет новые знания на практике. Рекомендуется больше практических заданий.',
                         '2024-02-18'),
                    ]
                    
                    for grade_data in test_grades:
                        cursor.execute(
                            """INSERT INTO grades 
                            (student_id, teacher_id, subject_id, competency_id, grade_value, percentage, comment, date) 
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
                            grade_data
                        )
                        
                        grade_id = cursor.lastrowid
                        
                        # Для каждой оценки добавляем соответствующие индикаторы
                        if grade_data[3] == pk_2_2_id:  # ПК 2.2 - добавляем 6 индикаторов
                            cursor.execute("SELECT id FROM fgos_indicators WHERE code LIKE 'ПК 2.2.%' LIMIT 6")
                            indicator_ids = [row[0] for row in cursor.fetchall()]
                        elif grade_data[3] == opk_3_1_id:  # ОПК 3.1 - добавляем 4 индикатора
                            cursor.execute("SELECT id FROM fgos_indicators WHERE code LIKE 'ОПК 3.1.%' LIMIT 4")
                            indicator_ids = [row[0] for row in cursor.fetchall()]
                        else:  # УК 3.1 - добавляем 3 индикатора
                            cursor.execute("SELECT id FROM fgos_indicators WHERE code LIKE 'УК 3.1.%' LIMIT 3")
                            indicator_ids = [row[0] for row in cursor.fetchall()]
                        
                        for indicator_id in indicator_ids:
                            cursor.execute(
                                "INSERT INTO grade_indicators (grade_id, indicator_id, score) VALUES (?, ?, ?)",
                                (grade_id, indicator_id, 1)
                            )

                conn.commit()
                print("✓ База данных инициализирована успешно")

            except Error as e:
                print(f"✗ Ошибка инициализации базы данных: {e}")
                import traceback
                traceback.print_exc()
            finally:
                cursor.close()
        else:
            print("✗ Не удалось подключиться к базе данных")

    def execute_query(self, query, params=()):
        """Выполнение SQL-запроса (INSERT, UPDATE, DELETE)"""
        try:
            cursor = self.connection.cursor()
            cursor.execute(query, params)
            self.connection.commit()
            return cursor
        except Error as e:
            print(f"Error executing query: {e}")
            return None

    def execute_select(self, query, params=()):
        """Выполнение SELECT запроса (без коммита)"""
        try:
            cursor = self.connection.cursor()
            cursor.execute(query, params)
            return cursor
        except Error as e:
            print(f"Error executing select: {e}")
            return None

    def fetch_all(self, query, params=()):
        """Получение всех результатов запроса"""
        cursor = self.execute_select(query, params)
        if cursor:
            return cursor.fetchall()
        return []

    def fetch_one(self, query, params=()):
        """Получение одного результата запроса"""
        cursor = self.execute_select(query, params)
        if cursor:
            return cursor.fetchone()
        return None

    def get_competencies_by_subject(self, subject_id):
        """Получение компетенций для предмета"""
        query = """
        SELECT DISTINCT fc.id, fc.code, fc.name, fc.type 
        FROM fgos_competencies fc
        JOIN subjects s ON fc.specialty = s.specialty
        WHERE s.id = ?
        ORDER BY fc.type, fc.code
        """
        return self.fetch_all(query, (subject_id,))

    def get_indicators_by_competency(self, competency_id):
        """Получение индикаторов для компетенции"""
        query = """
        SELECT id, code, description, weight, max_score
        FROM fgos_indicators
        WHERE competency_id = ?
        ORDER BY code
        """
        return self.fetch_all(query, (competency_id,))

    def add_grade_with_indicators(self, grade_data, selected_indicators):
        """Добавление оценки с выбранными индикаторами"""
        try:
            cursor = self.connection.cursor()
            
            # Вставляем оценку
            cursor.execute(
                """INSERT INTO grades 
                (student_id, teacher_id, subject_id, competency_id, grade_value, percentage, comment, date) 
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
                (grade_data['student_id'], grade_data['teacher_id'], grade_data['subject_id'],
                 grade_data['competency_id'], grade_data['grade_value'], grade_data['percentage'],
                 grade_data['comment'], grade_data['date'])
            )
            
            grade_id = cursor.lastrowid
            
            # Вставляем выбранные индикаторы
            for indicator_id in selected_indicators:
                cursor.execute(
                    "INSERT INTO grade_indicators (grade_id, indicator_id, score) VALUES (?, ?, ?)",
                    (grade_id, indicator_id, 1)
                )
            
            self.connection.commit()
            return True
        except Error as e:
            print(f"Error adding grade with indicators: {e}")
            return False

    def get_student_grades_with_details(self, student_id):
        """Получение оценок студента с деталями по ФГОС"""
        query = """
        SELECT g.id, s.name as subject, fc.code as competency_code, fc.name as competency_name,
               g.grade_value, g.percentage, g.comment, g.date, u.full_name as teacher_name,
               GROUP_CONCAT(fi.description, '; ') as indicators
        FROM grades g
        JOIN subjects s ON g.subject_id = s.id
        JOIN fgos_competencies fc ON g.competency_id = fc.id
        JOIN users u ON g.teacher_id = u.id
        LEFT JOIN grade_indicators gi ON g.id = gi.grade_id
        LEFT JOIN fgos_indicators fi ON gi.indicator_id = fi.id
        WHERE g.student_id = ?
        GROUP BY g.id
        ORDER BY g.date DESC
        """
        return self.fetch_all(query, (student_id,))

    def calculate_grade_from_indicators(self, selected_indicators, competency_id):
        """Расчет оценки на основе выбранных индикаторов с новой логикой"""
        if not selected_indicators:
            return 2, 0  # Если ничего не выбрано - не сформировано
        
        # Получаем все индикаторы для компетенции
        query = "SELECT id FROM fgos_indicators WHERE competency_id = ?"
        all_indicators = self.fetch_all(query, (competency_id,))
        
        if not all_indicators:
            return 2, 0
        
        total_indicators = len(all_indicators)
        selected_count = len(selected_indicators)
        
        # Рассчитываем процент освоения
        percentage = (selected_count / total_indicators) * 100 if total_indicators > 0 else 0
        
        # Новая логика оценки по количеству выбранных пунктов
        # Для 8 индикаторов: 5 (6-8 пунктов), 4 (5 пунктов), 3 (4 пункта), 2 (0-3 пункта)
        # Для 6 индикаторов: 5 (5-6 пунктов), 4 (4 пункта), 3 (3 пункта), 2 (0-2 пункта)
        
        if total_indicators >= 8:
            # Для компетенций с 8+ пунктами
            if selected_count >= 6:  # 6-8 пунктов из 8 = 75-100%
                return 5, percentage
            elif selected_count >= 5:  # 5 пунктов из 8 = 62.5%
                return 4, percentage
            elif selected_count >= 4:  # 4 пункта из 8 = 50%
                return 3, percentage
            else:
                return 2, percentage
        elif total_indicators >= 6:
            # Для компетенций с 6 пунктами
            if selected_count >= 5:  # 5-6 пунктов из 6 = 83-100%
                return 5, percentage
            elif selected_count >= 4:  # 4 пункта из 6 = 67%
                return 4, percentage
            elif selected_count >= 3:  # 3 пункта из 6 = 50%
                return 3, percentage
            else:
                return 2, percentage
        else:
            # Старая логика для других случаев
            if percentage >= 86:
                return 5, percentage
            elif percentage >= 67:
                return 4, percentage
            elif percentage >= 48:
                return 3, percentage
            else:
                return 2, percentage

    def get_competency_stats(self, competency_id):
        """Получение статистики по компетенции"""
        query = """
        SELECT 
            COUNT(DISTINCT fi.id) as total_indicators,
            AVG(g.percentage) as avg_percentage,
            COUNT(DISTINCT g.id) as total_grades
        FROM fgos_indicators fi
        LEFT JOIN grade_indicators gi ON fi.id = gi.indicator_id
        LEFT JOIN grades g ON gi.grade_id = g.id
        WHERE fi.competency_id = ?
        """
        return self.fetch_one(query, (competency_id,))

    def close(self):
        """Закрытие соединения с базой данных"""
        if self.connection:
            self.connection.close()
            print("Database connection closed")


# Пример использования
if __name__ == "__main__":
    # Создаем базу данных по указанному пути
    db = Database()
    
    # Проверяем соединение
    if db.connection:
        # Пример запроса
        users = db.fetch_all("SELECT * FROM users")
        print(f"Всего пользователей: {len(users)}")
        
        # Пример получения предметов
        subjects = db.fetch_all("SELECT * FROM subjects")
        print(f"Всего предметов: {len(subjects)}")
        
        # Пример получения компетенций
        competencies = db.fetch_all("SELECT * FROM fgos_competencies")
        print(f"Всего компетенций: {len(competencies)}")
        
        # Проверяем индикаторы для ПК 2.2
        cursor = db.connection.cursor()
        cursor.execute("SELECT id FROM fgos_competencies WHERE code = 'ПК 2.2'")
        pk_2_2_id = cursor.fetchone()[0]
        indicators = db.get_indicators_by_competency(pk_2_2_id)
        print(f"Всего индикаторов для ПК 2.2: {len(indicators)}")
        
        # Закрываем соединение
        db.close()