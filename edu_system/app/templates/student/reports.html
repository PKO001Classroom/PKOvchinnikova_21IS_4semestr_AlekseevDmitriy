{% extends 'base.html' %}

{% block title %}Отчет об успеваемости{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Отчет об успеваемости</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>Сводная информация</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h2 class="display-4">{{ avg_grade|floatformat:2 }}</h2>
                                <p class="text-muted">Средний балл</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h2 class="display-4">{{ grades.count }}</h2>
                                <p class="text-muted">Всего оценок</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                {% with grades|slice:":1" as first_grade %}
                                    {% if first_grade %}
                                        <h4>{{ first_grade.0.date|date:"d.m.Y" }}</h4>
                                        <p class="text-muted">Первая оценка</p>
                                    {% else %}
                                        <p class="text-muted">Нет данных</p>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                {% with grades|last as last_grade %}
                                    {% if last_grade %}
                                        <h4>{{ last_grade.date|date:"d.m.Y" }}</h4>
                                        <p class="text-muted">Последняя оценка</p>
                                    {% else %}
                                        <p class="text-muted">Нет данных</p>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% if grades %}
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-0">Детальная информация</h5>
                        </div>
                        <div class="col-md-6 text-end">
                            <form method="post" action="{% url 'student_report' %}">
                                {% csrf_token %}
                                <button type="submit" name="generate_pdf" 
                                        class="btn btn-primary">
                                    <i class="bi bi-file-pdf"></i> Скачать PDF отчет
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <h6>Распределение оценок:</h6>
                    <div class="mb-4">
                        {% for i in "5432" %}
                            {% with i|add:"0" as grade_value %}
                                {% with grades|filter_grade:grade_value as grade_count %}
                                    {% if grade_count %}
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar 
                                            {% if grade_value >= 4 %}bg-success
                                            {% elif grade_value == 3 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                             style="width: {{ grade_count|length|percentage:grades.count }}%">
                                            {{ grade_value }}: {{ grade_count|length }} оценок
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                    
                    <h6>По предметам:</h6>
                    <div class="row">
                        {% regroup grades by subject as subject_grades %}
                        {% for subject in subject_grades %}
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">{{ subject.grouper.name }}</h6>
                                    </div>
                                    <div class="card-body">
                                        {% with subject.list as subject_marks %}
                                            <p>Всего оценок: {{ subject_marks|length }}</p>
                                            <p>Средний балл: 
                                                {% with subject_marks|avg_grade as avg %}
                                                    {{ avg|floatformat:2 }}
                                                {% endwith %}
                                            </p>
                                            <p>Освоенные компетенции:</p>
                                            <ul>
                                                {% for grade in subject_marks %}
                                                    <li><code>{{ grade.competency_code }}</code></li>
                                                {% endfor %}
                                            </ul>
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-info">
                У вас пока нет оценок для формирования отчета.
            </div>
        {% endif %}
    </div>
</div>

{% if pdf_generated %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Автоматически скачиваем PDF после генерации
    window.open("{% url 'download_report' %}", '_blank');
});
</script>
{% endif %}
{% endblock %}