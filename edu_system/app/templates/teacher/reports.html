{% extends 'base.html' %}

{% block title %}Отчеты и аналитика{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Отчеты и аналитика</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>Статистика по предметам</h5>
            </div>
            <div class="card-body">
                {% if avg_by_subject %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Предмет</th>
                                    <th>Количество оценок</th>
                                    <th>Средний балл</th>
                                    <th>Лучший студент</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for subject_name, avg in avg_by_subject.items %}
                                {% with subject=subjects|get_subject_by_name:subject_name %}
                                <tr>
                                    <td>{{ subject_name }}</td>
                                    <td>
                                        {% with subject.grade_set.count as grade_count %}
                                            {{ grade_count }}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if avg >= 4.5 %}bg-success
                                            {% elif avg >= 4.0 %}bg-primary
                                            {% elif avg >= 3.5 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ avg }}
                                        </span>
                                    </td>
                                    <td>
                                        {% with subject.grade_set|best_student as best %}
                                            {% if best %}
                                                {{ best.student.get_full_name }} ({{ best.grade_value }})
                                            {% else %}
                                                -
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="showSubjectDetails({{ subject.id|default:0 }})">
                                            Детали
                                        </button>
                                    </td>
                                </tr>
                                {% endwith %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">У вас пока нет данных для анализа.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Все выставленные вами оценки</h5>
            </div>
            <div class="card-body">
                {% if grades %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" 
                                       placeholder="Поиск по студенту или предмету..." 
                                       id="searchInput">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="exportToCSV()">
                                <i class="bi bi-download"></i> Экспорт в CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="gradesTable">
                            <thead>
                                <tr>
                                    <th>Студент</th>
                                    <th>Группа</th>
                                    <th>Предмет</th>
                                    <th>Оценка</th>
                                    <th>Процент</th>
                                    <th>Компетенция</th>
                                    <th>Дата</th>
                                    <th>Комментарий</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for grade in grades %}
                                <tr>
                                    <td>{{ grade.student.get_full_name }}</td>
                                    <td>{{ grade.student.group_name }}</td>
                                    <td>{{ grade.subject.name }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if grade.grade_value >= 4 %}bg-success
                                            {% elif grade.grade_value == 3 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ grade.grade_value }}
                                        </span>
                                    </td>
                                    <td>{{ grade.percentage }}%</td>
                                    <td><code>{{ grade.competency_code }}</code></td>
                                    <td>{{ grade.date|date:"d.m.Y" }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-link" 
                                                data-bs-toggle="popover" 
                                                data-bs-title="Комментарий" 
                                                data-bs-content="{{ grade.comment }}">
                                            Показать
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        Вы еще не выставляли оценок.
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Генерация отчетов</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-journal-text text-primary"></i></h5>
                                <h6>Отчет по группе</h6>
                                <p class="text-muted">PDF отчет по успеваемости группы</p>
                                <button class="btn btn-outline-primary" disabled>
                                    В разработке
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-graph-up text-success"></i></h5>
                                <h6>Аналитика по ФГОС</h6>
                                <p class="text-muted">Освоение компетенций по ФГОС</p>
                                <button class="btn btn-outline-success" disabled>
                                    В разработке
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-calendar-check text-info"></i></h5>
                                <h6>Отчет за период</h6>
                                <p class="text-muted">Отчет по успеваемости за выбранный период</p>
                                <button class="btn btn-outline-info" disabled>
                                    В разработке
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Поиск по таблице
    const searchInput = document.getElementById('searchInput');
    const gradesTable = document.getElementById('gradesTable');
    
    if (searchInput && gradesTable) {
        searchInput.addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = gradesTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    }
    
    // Popover для комментариев
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
});

function exportToCSV() {
    let csv = [];
    const rows = document.querySelectorAll("#gradesTable tr");
    
    for (let row of rows) {
        let cols = row.querySelectorAll("td, th");
        let rowData = [];
        
        for (let col of cols) {
            let text = col.textContent.trim();
            // Убираем лишние пробелы и символы
            text = text.replace(/\s+/g, ' ').replace(/,/g, ';');
            rowData.push(text);
        }
        
        csv.push(rowData.join(","));
    }
    
    // Создаем и скачиваем файл
    const csvContent = csv.join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'grades_report_' + new Date().toISOString().slice(0,10) + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function showSubjectDetails(subjectId) {
    alert('Детальная информация по предмету будет реализована в следующей версии.');
}
</script>
{% endblock %}