{% extends 'base.html' %}

{% block title %}Выставить оценку{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Выставление оценки</h1>
        
        <div class="card">
            <div class="card-header">
                <h5>Форма выставления оценки</h5>
            </div>
            <div class="card-body">
                <form method="post" id="gradeForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.student.id_for_label }}" class="form-label">
                                    <strong>Студент *</strong>
                                </label>
                                {{ form.student }}
                                <div class="form-text">Выберите студента из ваших групп</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.subject.id_for_label }}" class="form-label">
                                    <strong>Предмет *</strong>
                                </label>
                                {{ form.subject }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.competency_code.id_for_label }}" class="form-label">
                                    <strong>Компетенция ФГОС *</strong>
                                </label>
                                {{ form.competency_code }}
                                <div class="form-text">Выберите из списка компетенций</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.percentage.id_for_label }}" class="form-label">
                                    <strong>Процент освоения *</strong>
                                </label>
                                {{ form.percentage }}
                                <div class="form-text">0-100%</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="calculated_grade" class="form-label">
                                    <strong>Расчетная оценка</strong>
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="calculated_grade" 
                                           readonly placeholder="Рассчитывается автоматически">
                                    <span class="input-group-text" id="grade_level"></span>
                                </div>
                                <div class="form-text">Оценка рассчитывается по проценту</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.date.id_for_label }}" class="form-label">
                                    <strong>Дата выставления *</strong>
                                </label>
                                {{ form.date }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="comment_length" class="form-label">
                                    <strong>Длина комментария</strong>
                                </label>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar" id="comment_progress" 
                                         style="width: 0%"></div>
                                </div>
                                <div class="form-text">Минимум 100 символов</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.comment.id_for_label }}" class="form-label">
                            <strong>Комментарий *</strong>
                        </label>
                        {{ form.comment }}
                        <div class="form-text">
                            <ul>
                                <li>Минимум 100 символов</li>
                                <li>Должен содержать код компетенции</li>
                                <li>Опишите достижения студента и рекомендации</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning" id="validation_warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span id="warning_text"></span>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="submit_button">
                        <i class="bi bi-save"></i> Сохранить оценку
                    </button>
                    <a href="{% url 'teacher_dashboard' %}" class="btn btn-secondary">
                        Отмена
                    </a>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>Помощь по заполнению</h5>
            </div>
            <div class="card-body">
                <h6>Пример хорошего комментария:</h6>
                <blockquote class="blockquote bg-light p-3 rounded">
                    <p>"Студент Иванов И.И. продемонстрировал <strong>ПК 1.2</strong> в ходе выполнения лабораторной работы 
                    по чтению чертежей. Правильно определил 8 из 10 размеров, допустил ошибки в определении 
                    допусков. Рекомендую дополнительную практику с чертежами повышенной сложности."</p>
                    <footer class="blockquote-footer">Длина: 145 символов</footer>
                </blockquote>
                
                <h6>Что проверяет система:</h6>
                <ol>
                    <li>Длина комментария ≥ 100 символов</li>
                    <li>Наличие кода компетенции в тексте</li>
                    <li>Не более одной оценки в неделю по предмету</li>
                    <li>Процент освоения в пределах 0-100%</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Автоматический расчет оценки при изменении процента
    const percentageInput = document.getElementById('id_percentage');
    const calculatedGrade = document.getElementById('calculated_grade');
    const gradeLevel = document.getElementById('grade_level');
    const commentInput = document.getElementById('id_comment');
    const commentProgress = document.getElementById('comment_progress');
    const competencySelect = document.getElementById('id_competency_code');
    
    function calculateGradeFromPercentage(percentage) {
        if (percentage >= 86 && percentage <= 100) {
            return {grade: 5, level: 'Высокий', color: 'success'};
        } else if (percentage >= 67 && percentage <= 85) {
            return {grade: 4, level: 'Повышенный', color: 'primary'};
        } else if (percentage >= 48 && percentage <= 66) {
            return {grade: 3, level: 'Базовый', color: 'warning'};
        } else if (percentage >= 0 && percentage <= 47) {
            return {grade: 2, level: 'Не сформировано', color: 'danger'};
        } else {
            return {grade: '?', level: 'Некорректный', color: 'secondary'};
        }
    }
    
    percentageInput.addEventListener('input', function() {
        const percentage = parseInt(this.value) || 0;
        const result = calculateGradeFromPercentage(percentage);
        
        calculatedGrade.value = result.grade;
        gradeLevel.textContent = result.level;
        gradeLevel.className = 'input-group-text text-white bg-' + result.color;
        
        // Обновляем цвет поля ввода
        if (percentage >= 0 && percentage <= 100) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    });
    
    // Отслеживание длины комментария
    commentInput.addEventListener('input', function() {
        const length = this.value.length;
        const progress = Math.min((length / 100) * 100, 100);
        
        commentProgress.style.width = progress + '%';
        commentProgress.textContent = length + ' символов';
        
        if (length < 100) {
            commentProgress.className = 'progress-bar bg-danger';
        } else {
            commentProgress.className = 'progress-bar bg-success';
        }
        
        // Проверка наличия кода компетенции
        const warningDiv = document.getElementById('validation_warning');
        const warningText = document.getElementById('warning_text');
        const submitButton = document.getElementById('submit_button');
        
        if (competencySelect && competencySelect.value) {
            const competencyCode = competencySelect.options[competencySelect.selectedIndex].text;
            const codeMatch = competencyCode.match(/[ПОКУ]К?\s*\d+\.\d+/);
            
            if (codeMatch) {
                const requiredCode = codeMatch[0];
                
                if (length >= 100 && !this.value.includes(requiredCode)) {
                    warningText.textContent = `В комментарии отсутствует код компетенции: ${requiredCode}`;
                    warningDiv.style.display = 'block';
                    submitButton.disabled = true;
                } else {
                    warningDiv.style.display = 'none';
                    submitButton.disabled = false;
                }
            }
        }
    });
    
    // Инициализация при загрузке
    if (percentageInput.value) {
        percentageInput.dispatchEvent(new Event('input'));
    }
    
    if (commentInput.value) {
        commentInput.dispatchEvent(new Event('input'));
    }
});
</script>

<style>
.progress-bar {
    transition: width 0.3s ease;
}
#calculated_grade {
    font-weight: bold;
    font-size: 1.2em;
}
</style>
{% endblock %}